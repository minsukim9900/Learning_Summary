# DB - Join & SubQuery

## JOIN

### JOIN?

- 둘 이상의 테이블에서 데이터를 조회하기 위해서 사용
- 일반적으로 조인조건은 PK(Primary Key) 및 FK(Foreign Key)로 구성
- PK 및 FK 관계가 없더라도 논리적인 연관만으로 JOIN 가능
- JOIN의 종류
    - INNER JOIN : 조인 조건에 해당한느 칼럼 값이 양쪽 테이블에 모두 존재하는 경우에만 조회
    동등 조인(Equi-join)이라고도 한다.
    N개의 테이블 조인 시 N-1개의 조인 조건이 필요
    - OUTER JOIN : 조인 조건에 해당하는 칼럼 값이 한 쪽에 테이블에만 존재 하더라도 조회 기준 테이블에 따라 LEFT OUTER JOIN, RIGHT OUTER JOIN으로 구분

### 카타시안 곱(Cartesian Product)

- 두 개이상의 테이블에서 데이터를 조회할 때
    - 조인 조건을 지정하지 않음
    - 조인 조건이 부적합 함
- 첫 번째 테이블의 모든 행이 두 번째 테이블의 모든 행에 조인되어 처리

### INNER JOIN

- 두 테이블에서 일치하는 값을 가진 레코드를 조회
- INNER JOIN절을 쓰지 않고, WHERE 절만으로도 INNER JOIN 가능

### OUTER JOIN

- 두 테이블에서 하나의 테이블에 조인조건 데이터가 존재하지 않더라도 (조인조건을 만족하지 않음) 데이터를 조회하기 위해서 사용
- 기준 테이블에 따라 LEFT OUTER JOOIN (LEFT JOIN), RIGHT OUTER JOIN(RIGHT JOIN)으로 구분

### 셀프 조인(SELF JOIN)

- 같은 테이블 2개를 조인

### 비 동등 조인(Non-Equi JOIN)

- 조인조건이 table의 PK, FK 등으로 정확히 일치하는 것이 아닐때 사용

## SubQuery

### 서브 쿼리(SubQuery) 란?

- 서브 쿼리란 하나의 SQL 문안에 포함되어 있는 SQL문을 의미
- 서브 쿼리를 포함하는 SQL을 외부 쿼리(outer query) 또는 메인 쿼리라고 부르며,
서브 쿼리는 내부 쿼리(inner query) 라고도 부름

### 서브 쿼리의 종류

- 중첩 서브 쿼리(Nested Subquery) - WHERE 절에 작성하는 서브 쿼리
    - 단일 - 행, 다중 - 행, 다중 - 열
- 인라인 뷰(Inline-view) - FROM 절에 작성하는 서브 쿼리
- 스칼라 서브 쿼리(Scalar Subquery) - SELECT 문에 작성하는 서브 쿼리

### 서브 쿼리를 포함할 수 있는 SQL 문

- SELECT, FROM, WHERE, HAVING, ORDER BY
- INSERT문의 VALUES
- UPDATE문의 SET

### 서브 쿼리의 사용시 주의사항

- 서브 쿼리는 반드시 ( ) 로 감싸서 사용
- 서브 쿼리는 단일 행 또는 다중 행 비교 연산자와 함께 사용 가능
    - 단일 행 비교연산자는 서브 쿼리 겨로가가 1건 이하이어야 하고,
    복수 행 비교 연산자는 결과 건수와 상관 없다.

## Modeling

### 개념적 데이터베이스 모델링

1. 사용자 부분의 처리현상을 분석
2. 중요 실체와 관계를 파악하여 ERD를 작성
3. 실체에 대한 상세 정의
4. 식별자를 정의, 식별자 업무규칙을 정한다.
5. 실체별로 속성을 상세화
6. 필요한 속성 및 영역을 상세 정의
7. 속성에 대한 업무규칙을 정의
8. 각 단계를 마친 후 사용자와 함께 모델을 검토

- 개체(Entity) : 사용자와 관계가 있는 주요 객체 (데이터로 관리 되어야 하는 것)
- Entity 찾는 법
    - 영속적으로 존재하는 것
    - 새로 식별이 가능한 데이터 요소를 가짐
    - Entity는 Attribute를 가져야 함
- 속성(Attribute) (10개 안넘어가는것을 권장)
    - 저장할 필요가 있는 실체에 관한 정보
    - 개체(Entity)의 성질, 분류, 수량, 상태, 특성 등을 나타내는 세부사항
    - 개체에 포함되는 속성의 숫자는 10개 내외로 하는 것이 바람직함
    - 최종 DB 모델링 단계를 통해 테이블의 컬럼으로 활용

- 식별자 : 한 개체(Entity) 내에서 인스턴스를 구분할 수 있는 단일 속성 또는 속성 그룹
- 후보키(Candidate Key) : 개체내에서 각각의 인스턴스를 구분할 수 있는 속성(기본키가 될 수 있음)
- 기본키(Primary Key) : 개체(Entity)에서 인스턴스를 유일하게 식별하는데 적합한 Key
- 대체키(Alternate Key) : 후보키 중에서 기본키로 선정되지 않은 Key
- 복합키(Composite Key) : 하나의 속성으로 기본키가 될 수 없는 경우 둘 이상의 컬럼을 묶어서 식별자로 정의
- 대리키 (Surrogate Key) : 식별자가 너무 길거나 여러 개의 속성으로 구성되어 있는 경우 인위적으로 추가
- 관계 (Relationship) : 두 Entity간의 업무적인 연관성 또는 고나련 사실
- 각 Entity간에 특정한 존재여부 결정
- 현재의 관계 뿐만 아니라 장래에 사용될 경우도 고려

- **ERD 관계를 설정하는 순서**
1. 관계가 있는 두 실체를 실선(점선)으로 연결하고 관계를 부여
2. 관계 차수를 표현
3. 선택성을 표시

- 차수의 종류
    - 1 : 1 (일 대 일) ⇒ 두 실체의 레코드가 서로 하나씩 대응
    - 1 : N (일 대 다) ⇒ 부모 실체의 하나의 레코드가 자식 실체의 여러 레코드에 대응
    - N : M (다 대 다) ⇒ 양쪽 실체 간에 여러 개의 레코드와 관계를 맺을 수 있는 경우

### 논리적 데이터베이스 모델링

- 개념적 데이터베이스 모델링 단계에서 정의된 ER-Diagram을 Mapping Rule을 적용
관계형 데이터베이스 이론에 입각한 스키마를 설계하는 단계와 이를 이용하여 필요하다면 정규화하는 단계로 구성

- 기본키(Primary Key)
    - 후보키 중에서 선택한 주 키
    - 널(Null)의 값을 가질 수 없다 (Not Null).
    - 동일한 값이 중복해서 저장될 수 없다.(Unique).
- 참조키, 이웃키(Foreign Key)
    - 관계를 맺는 두 엔티티에서 서로 참조하는 릴레이션의 attribute로 지정되는 키

- Mapping Rule
    - 개념적 데이터베이스 모델링에서 도출된 개체 타입과 관계 타입의 테이블 정의
    - 단순 엔티티 → 테이블
    - 속성 → 컬럼
    - 식별자 → 기본키
    - 관계 → 참조키, 테이블
- 정규화
    - 관계형 데이터베이스 설계에서 중복을 최소화하게 데이터를 구조화하는 프로세스를 말함
- 정규화의 목적
    - 데이터베이스의 변경 시 이상 현상 제거
    - 데이터베이스 구조 확장 시 재 디자인 최소화
    - 사용자에게 데이터 모델을 더욱 의미있게 작성하도록함
    - 다양한 질의 지원

### 물리적 데이터베이스 모델링

- 논리적 데이터베이스 모델링 단계에서 얻어진 데이터베이스 스키마를 좀 더 효우ㅜㄹ적으로 구현하기 위한 작업
- DBMS 특성에 맞게 실제 데이터베이스내의 개체들을 정의하는 단계
    - Column의 domain 설정(int, varchar, date,…)
- 데이터 사용량 분석과 업무 프로세스 분석을 통해서 보다 효율적인 데이터베이스가 될 수 있도록 효과적인 인덱스를 정의하고 상황에 따른 역정규화 작업을 수행
    - index, Trigger, 역정규화.

- 역정규화(Denomalization)
    - 시스템 성능을 고려하여 기존 설계를 재구성
    - 정규화에 위배되는 행동
    - 테이블의 재구성
- 역정규화 방법
    - 데이터 중복 (컬럼 역정규화)
    - 파생 컬럼의 생성
    - 테이블 분리
    - 요약 테이블 생성
    - 테이블 통합